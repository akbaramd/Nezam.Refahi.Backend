<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <TargetFramework>net8.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="Microsoft.Extensions.Http" Version="8.0.1" />
        <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.18" />
        <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.18">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="8.0.18" />
        <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.18" />
        <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.18" />
        <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.18"/>
    </ItemGroup>
    <ItemGroup>
      <ProjectReference Include="..\..\Modules\Identity\Nezam.Refahi.Identity.Infrastructure\Nezam.Refahi.Identity.Infrastructure.csproj" />
      <ProjectReference Include="..\..\Modules\Membership\Nezam.Refahi.Membership.Contracts\Nezam.Refahi.Membership.Contracts.csproj" />
      <ProjectReference Include="..\..\Modules\BasicDefinitions\Nezam.Refahi.BasicDefinitions.Contracts\Nezam.Refahi.BasicDefinitions.Contracts.csproj" />
    </ItemGroup>

    <!-- Generate plugin.json manifest file -->
    <Target Name="GeneratePluginJson" AfterTargets="Build">
        <PropertyGroup>
            <PluginJsonPath>$(MSBuildProjectDirectory)\plugin.json</PluginJsonPath>
            <PluginJsonContent>{
  "name": "$(MSBuildProjectName)",
  "version": "1.0.0",
  "description": "Nezam Mohandesi external member storage plugin",
  "authors": ["Nezam Refahi Team"],
  "entryPoint": "$(MSBuildProjectName).dll",
  "additionalFiles": [
    "Nezam.Refahi.Membership.Contracts.dll",
    "Nezam.Refahi.Membership.Domain.dll",
    "Nezam.Refahi.Shared.Domain.dll"
  ],
  "tags": ["membership", "external-storage", "nezam-mohandesi"]
}</PluginJsonContent>
        </PropertyGroup>
        
        <!-- Generate plugin.json if it doesn't exist or update it -->
        <Message Text="Generating plugin.json at: $(PluginJsonPath)" Importance="normal" />
        <WriteLinesToFile 
            File="$(PluginJsonPath)" 
            Lines="$(PluginJsonContent)" 
            Overwrite="true" />
        <Message Text="Generated plugin.json for $(MSBuildProjectName)" Importance="high" />
    </Target>

    <!-- Copy plugin files to both WebApi and Identity Worker Plugins directories -->
    <Target Name="CopyPluginToWebApi" AfterTargets="Build" DependsOnTargets="GeneratePluginJson">
        <PropertyGroup>
            <WebApiPluginDir>..\..\Nezam.Refahi.WebApi\Plugins\$(AssemblyName)</WebApiPluginDir>
            <IdentityWorkerPluginDir>..\..\Modules\Identity\Nezam.Refahi.Identity.Worker\Plugins\$(AssemblyName)</IdentityWorkerPluginDir>
            <PluginJsonPath>$(MSBuildProjectDirectory)\plugin.json</PluginJsonPath>
        </PropertyGroup>
        
        <!-- Copy to WebApi Plugins directory -->
        <MSBuild Projects="$(MSBuildProjectFile)" Targets="CopyPluginFiles" Properties="TargetDir=$(WebApiPluginDir)" />
        
        <!-- Copy to Identity Worker Plugins directory -->
        <MSBuild Projects="$(MSBuildProjectFile)" Targets="CopyPluginFiles" Properties="TargetDir=$(IdentityWorkerPluginDir)" />
        
        <Message Text="Plugin files copied to both WebApi and Identity Worker Plugins directories" Importance="high" />
    </Target>

    <!-- Helper target to copy plugin files to a specific directory -->
    <Target Name="CopyPluginFiles">
        <PropertyGroup>
            <PluginJsonPath>$(MSBuildProjectDirectory)\plugin.json</PluginJsonPath>
        </PropertyGroup>
        
        <!-- Remove old plugin files -->
        <ItemGroup>
            <OldPluginFiles Include="$(TargetDir)\**\*.*" />
        </ItemGroup>
        <Delete Files="@(OldPluginFiles)" ContinueOnError="true" />
        <RemoveDir Directories="$(TargetDir)" ContinueOnError="true" />
        
        <!-- Create plugin directory -->
        <MakeDir Directories="$(TargetDir)" />
        
        <!-- Copy plugin.json manifest -->
        <Copy SourceFiles="$(PluginJsonPath)" DestinationFolder="$(TargetDir)" Condition="Exists('$(PluginJsonPath)')" />
        
        <!-- Copy all DLL files from output directory -->
        <ItemGroup>
            <DllFiles Include="$(OutputPath)*.dll" />
        </ItemGroup>
        <Copy SourceFiles="@(DllFiles)" DestinationFolder="$(TargetDir)" />
        
        <!-- Copy PDB files for debugging -->
        <ItemGroup>
            <PdbFiles Include="$(OutputPath)*.pdb" />
        </ItemGroup>
        <Copy SourceFiles="@(PdbFiles)" DestinationFolder="$(TargetDir)" ContinueOnError="true" />
        
        <!-- Copy any additional files -->
        <ItemGroup>
            <AdditionalFiles Include="$(OutputPath)*.json" Exclude="$(OutputPath)*plugin.json" />
            <AdditionalFiles Include="$(OutputPath)*.xml" />
        </ItemGroup>
        <Copy SourceFiles="@(AdditionalFiles)" DestinationFolder="$(TargetDir)" ContinueOnError="true" />
        
        <Message Text="Plugin files copied to: $(TargetDir)" Importance="high" />
    </Target>

</Project>
